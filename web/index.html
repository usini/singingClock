<!DOCTYPE html>
<html>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">

<body>
    <div class="container">
        <h1>REMOS</h1>
        <div class="grid">
            <div>
                <button id="btn_connect" onclick="connection();">Connect</button>
            </div>
            <div>
                <button id="btn_reboot" disabled onclick='serial.write("reboot")'>Reboot</button>
            </div>
            <div>
                <button id="btn_status" disabled onclick='serial.write("status")'>Status</button>
            </div>
        </div>
        <h2>Status</h2>
        <table>
            <tr>
                <td>Flash</td>
                <td>SD</td>
                <td>Video</td>
                <td>Serial</td>
                <td>WiFi</td>
            </tr>
            <tr>
                <td><span id="flash_status">?</span></td>
                <td><span id="sd_status">?</span></td>
                <td><span id="video_status">?</span></td>
                <td><span id="serial_status">?</span></td>
                <td><span id="wifi_status">?</span></td>
            </tr>
        </table>
        <h2>Time</h2>
        <center>
            <h3 id="hour_text">??:??</h3>
        </center>
        <h2>WiFi Settings</h2>
        <table>
            <tr>
                <td>SSID</td>
                <td>Password</td>
                <td></td>
            </tr>
            <tr>
                <td> <input id="ssid_input" type="text"></td>
                <td> <input id="pass_input" type="password"></td>
                <td><button onclick="change_wifi()">Change</button></td>
            </tr>
        </table>
        <p id="error"></p>
    </div>
</body>
<script type="text/javascript" src="esprerial.js"></script>
<script>
    // Create Esprerial with baudrate 115200 / endline= "\r\n"
    serial = new Esprerial();
    serial.setStart(serial_start);
    serial.setError(serial_error);
    serial.setRead(serial_read);
    connection_status = false;

    function connection() {

        if (connection_status == false) {
            serial.begin();

        } else {
            serial.close();
            document.getElementById("btn_connect").innerHTML = "Connect"
            document.getElementById("btn_reboot").disabled = true;
            document.getElementById("btn_status").disabled = true;
            connection_status = false;
        }
    }

    async function serial_start() {
        console.log("Starting");
        connection_status = true;
        document.getElementById("serial_status").innerHTML = "ğŸŸ¢";
        await serial.write("status");
        document.getElementById("btn_connect").innerHTML = "Disconnect"
        document.getElementById("btn_reboot").disabled = false;
        document.getElementById("btn_status").disabled = false;
    }

    async function change_wifi() {
        await serial.write("ssidÂ§" + document.getElementById("ssid_input").value);
        await serial.write("passÂ§" + document.getElementById("pass_input").value);
        await serial.write("wifiÂ§restart");
    }

    function serial_read(message) {
        message = message.trim();
        console.log(message);
        if (message == "[ğŸ“¶ WIFI] ...") {
            document.getElementById("wifi_status").innerHTML = "ğŸ”´";
        }
        if (message == "[ğŸ“¶ WIFI] ğŸŸ¢") {
            document.getElementById("wifi_status").innerHTML = "ğŸŸ¢";
        }
        if (message == "[ğŸ’¾ FS] ğŸŸ¢ OK") {
            document.getElementById("flash_status").innerHTML = "ğŸŸ¢";
        }
        if (message == "[ğŸ’¾ FS] ğŸ”´ Failed") {
            document.getElementById("flash_status").innerHTML = "ğŸ”´";
        }
        if (message == "[ğŸ’¾ SD] ğŸŸ¢ OK") {
            document.getElementById("sd_status").innerHTML = "ğŸŸ¢";
        }
        if (message == "[ğŸ’¾ SD] ğŸ”´ Failed") {
            document.getElementById("sd_status").innerHTML = "ğŸ”´";
        }
        if (message == "[ğŸ–¥ï¸  Display] ğŸŸ¢ OK") {
            document.getElementById("video_status").innerHTML = "ğŸŸ¢";
        }
        if (message == "[ğŸ–¥ï¸  Display] ğŸ”´ Failed") {
            document.getElementById("video_status").innerHTML = "ğŸ”´";
        }
        if (message.includes("[ğŸ“¶ WIFI] ğŸ·ï¸ SSID -")) {
            document.getElementById("ssid_input").value = message.split("-")[1].trim();
        }
    }

    function serial_error(error) {
        console.log(error);
        document.getElementById("error").innerHTML += error;
        document.getElementById("serial_status").innerHTML = "ğŸ”´";
        document.getElementById("btn_reboot").disabled = true;
        document.getElementById("btn_status").disabled = true;
    }
</script>

</html>